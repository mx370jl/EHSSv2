<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Reporting - Beautiful Form</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; position: relative;
        }
        .background-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1;
            background-image:
                radial-gradient(circle at 20% 50%, white 1px, transparent 1px),
                radial-gradient(circle at 70% 80%, white 1px, transparent 1px);
            background-size: 50px 50px; pointer-events: none; z-index: 0;
        }
        .container { max-width: 900px; margin: 0 auto; position: relative; z-index: 1; }
        .form-container {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.2);
            padding: 40px; border: 1px solid rgba(255,255,255,0.2);
        }
        h1 {
            color: #2d3748; margin-bottom: 30px; font-size: 2.5rem; font-weight: 700; text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        h2 { color: #4a5568; margin-bottom: 20px; font-size: 1.5rem; font-weight: 600; text-align: center; }
        .form-group { margin-bottom: 25px; position: relative; opacity: 1; transform: translateY(0); }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748; font-size: 0.95rem; transition: color 0.2s ease; }
        .required::after { content: " *"; color: #e53e3e; }
        input, select, textarea {
            width: 100%; padding: 15px 18px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px;
            font-family: inherit; background: rgba(255,255,255,0.9); transition: all 0.3s ease; outline: none;
        }
        input:focus, select:focus, textarea:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); background: white; transform: translateY(-1px); }
        input:disabled, select:disabled, textarea:disabled { background: #f7fafc; color: #a0aec0; cursor: not-allowed; opacity: 0.6; }
        textarea { height: 120px; resize: vertical; font-family: inherit; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer; margin-right: 15px; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3); position: relative; overflow: hidden;
        }
        button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        button:hover::before { left: 100%; }
        button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
        button:active { transform: translateY(0); }
        button:disabled { background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none; }
        button:disabled::before { display: none; }
        .signin-section { text-align: center; padding: 60px 0; }
        .signin-section .icon { font-size: 4rem; margin-bottom: 20px; color: #667eea; }
        .hidden { display: none; }
        .dynamic-fields {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 30px; border-radius: 16px; margin-top: 20px; border-left: 4px solid #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .dynamic-fields h3 { margin-top: 0; margin-bottom: 20px; color: #2d3748; font-size: 1.3rem; font-weight: 600; }
        .result { margin-top: 25px; padding: 20px; border-radius: 12px; font-weight: 600; text-align: center; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
        .result.success { background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); color: #22543d; border: 2px solid #68d391; }
        .result.error { background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%); color: #742a2a; border: 2px solid #fc8181; }
        .result.loading { background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%); color: #2a69ac; border: 2px solid #63b3ed; }
        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 20px; z-index: 100;
        }
        .spinner { width: 60px; height: 60px; border: 4px solid #e2e8f0; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .loading-text { color: #4a5568; font-size: 1.1rem; font-weight: 600; text-align: center; margin-bottom: 10px; }
        .loading-subtext { color: #718096; font-size: 0.9rem; text-align: center; max-width: 250px; }
        .form-loading input, .form-loading select, .form-loading textarea, .form-loading button { pointer-events: none; opacity: 0.6; }
        .success-icon { display: inline-block; width: 20px; height: 20px; border-radius: 50%; background: #48bb78; margin-right: 10px; position: relative; }
        .success-icon::after { content: '‚úì'; position: absolute; color: white; font-size: 12px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .error-icon { display: inline-block; width: 20px; height: 20px; border-radius: 50%; background: #f56565; margin-right: 10px; position: relative; }
        .error-icon::after { content: '!'; position: absolute; color: white; font-size: 14px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        @media (max-width: 768px) {
            .container { margin: 10px; }
            .form-container { padding: 25px; border-radius: 15px; }
            h1 { font-size: 2rem; }
            input, select, textarea { padding: 12px 15px; }
            button { padding: 14px 28px; font-size: 15px; }
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>

    <div class="container">
        <!-- Sign-in Section -->
        <div id="signinSection" class="signin-section">
            <div class="form-container">
                <div class="icon">üõ°Ô∏è</div>
                <h1>Incident Reporting System</h1>
                <h2>Please sign in with your company credentials</h2>
                <button id="signinButton">üîê Sign In with Microsoft</button>
            </div>
        </div>

        <!-- Main Form -->
        <div id="mainForm" class="hidden">
            <div class="form-container">
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading Form Data</div>
                    <div class="loading-subtext">Please wait while we fetch incident types and locations...</div>
                </div>

                <h1>üìã Report an Incident</h1>

                <form id="incidentForm" class="form-loading">
                    <div class="form-group">
                        <label for="incidentType" class="required">What work related event do you want to report?</label>
                        <select id="incidentType" required disabled>
                            <option value="">Select event type...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="occurredAt" class="required">When did the event occur?</label>
                        <input type="datetime-local" id="occurredAt" required disabled>
                    </div>

                    <div class="form-group">
                        <label for="location">Where did the incident occur?</label>
                        <input type="text" id="location" disabled placeholder="Loading locations...">
                    </div>

                    <div class="form-group">
                        <label for="description">Please describe the event</label>
                        <textarea id="description" disabled placeholder="Detailed description of what happened"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="workOrder" class="required">Is there a work order open</label>
                        <select id="workOrder" required disabled>
                            <option value="">Select a response...</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                            
                        </select>
                    </div>

                    <!-- Dynamic Fields Section -->
                    <div id="dynamicFields"></div>

                    <button type="submit" disabled>
                        <span id="submitButtonText">Submit Incident Report</span>
                    </button>
                    <div id="result"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- MSAL Library -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

    <script>
        console.log("=== SCRIPT STARTED - PAGE LOADED ===");

        // Configuration
        const msalConfig = {
            auth: {
                clientId: "7f02037e-2cdc-4a25-b069-b846beb3ea84",
                authority: "https://login.microsoftonline.com/7002c3bb-3e4e-4ab7-8b11-65cd3513ecbe",
                redirectUri: window.location.origin + "/"
            },
            cache: { cacheLocation: "sessionStorage" }
        };

        // API Configuration
        const apiBaseUrl = "https://apimhumacyte.azure-api.net/incident";
        const apiScope = "api://7f02037e-2cdc-4a25-b069-b846beb3ea84/Incidents.Submit";

        // Only use API scope for login
        const loginScopes = [apiScope, "openid", "profile", "offline_access"];

        // Initialize MSAL
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Helper functions
        function getCurrentAccount() {
            return msalInstance.getAllAccounts()[0];
        }

        async function acquireToken() {
            const account = getCurrentAccount();
            if (!account) { throw new Error("No account found"); }

            try {
                const result = await msalInstance.acquireTokenSilent({
                    account: account,
                    scopes: [apiScope]  // Only API scope
                });
                return result.accessToken;
            } catch (error) {
                console.log("Silent token acquisition failed, acquiring token using popup");
                const result = await msalInstance.acquireTokenPopup({ 
                    scopes: [apiScope]
                });
                return result.accessToken;
            }
        }

        // Loading state management
        function showLoading() {
            document.getElementById("loadingOverlay").style.display = "flex";
            document.getElementById("incidentForm").classList.add("form-loading");
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
            document.getElementById("incidentForm").classList.remove("form-loading");
            enableOnlyIncidentType();
        }

        function enableOnlyIncidentType() {
            const all = document.querySelectorAll("#incidentForm input, #incidentForm select, #incidentForm textarea, #incidentForm button");
            all.forEach(el => el.disabled = true);
            const incidentTypeSelect = document.getElementById("incidentType");
            incidentTypeSelect.disabled = false;
        }

        function setRestEnabled(isEnabled) {
            const selectors = ["#occurredAt", "#location", "#description", "#workOrder", "#incidentForm button[type='submit']"];
            selectors.forEach(sel => {
                const el = document.querySelector(sel);
                if (el) el.disabled = !isEnabled;
            });

            const dynamicInputs = document.querySelectorAll("#dynamicFields input, #dynamicFields select, #dynamicFields textarea");
            dynamicInputs.forEach(el => el.disabled = !isEnabled);
        }

        // Data fetching function
        async function fetchReferenceData() {
            console.log("=== Starting fetchReferenceData ===");
            try {
                const response = await fetch(`${apiBaseUrl}/referencedata`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" }
                });

                console.log("Response received:", response.status, response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    console.log("=== RAW RESPONSE DATA ===");
                    console.log(JSON.stringify(data, null, 2));
                    return data;
                } else {
                    const errorText = await response.text();
                    console.error("Failed to fetch reference data:", response.status, errorText);
                    return null;
                }
            } catch (error) {
                console.error("=== FETCH ERROR ===", error);
                return null;
            }
        }

        // Populate dropdowns with correct field names and data attributes for locations
        async function loadDropdownData() {
            console.log("=== Starting loadDropdownData ===");
            showLoading();

            const incidentTypeSelect = document.getElementById("incidentType");
            const locationInput = document.getElementById("location");

            try {
                const referenceData = await fetchReferenceData();
                console.log("Reference data received:", referenceData);

                // INCIDENT TYPES - Use correct field names from API response
                if (referenceData?.incidentTypes?.length) {
                    incidentTypeSelect.innerHTML = '<option value="">Select event type...</option>';
                    referenceData.incidentTypes.forEach(type => {
                        const option = document.createElement('option');
                        // Use correct field names from your JSON response
                        option.value = type.humit_humacyteincidenttypeid;
                        option.textContent = type.humit_incidenttypename;
                        incidentTypeSelect.appendChild(option);
                        console.log("Added incident type:", type.humit_incidenttypename);
                    });
                } else {
                    console.log("No incident types found, using fallback");
                    incidentTypeSelect.innerHTML = `
                        <option value="">Select event type...</option>
                        <option value="injury">Injury</option>
                        <option value="illness">Illness</option>
                        <option value="near-miss">Near Miss</option>
                        <option value="environmental">Environmental</option>
                        <option value="property-damage">Property Damage</option>
                        <option value="security">Security</option>
                        <option value="other">Other</option>
                    `;
                }

                // LOCATIONS - Use data attributes instead of JSON
                const locations = referenceData?.locations?.ResultSets?.Table1;
                if (locations?.length) {
                    const locationGroup = locationInput.parentElement;
                    const newSelect = document.createElement('select');
                    newSelect.id = 'location';
                    newSelect.innerHTML = '<option value="">Select location...</option>';

                    locations.forEach(loc => {
                        const opt = document.createElement('option');
                        // Use simple value and store additional data in data attributes
                        opt.value = loc.Humacyte_Location;
                        opt.setAttribute('data-description', loc.Humacyte_Location_Description);
                        opt.setAttribute('data-details', loc.Humacyte_Location_Details);
                        opt.textContent = `${loc.Humacyte_Location} - ${loc.Humacyte_Location_Description}`;
                        opt.title = loc.Humacyte_Location_Details;
                        newSelect.appendChild(opt);
                    });

                    locationGroup.replaceChild(newSelect, locationInput);
                    console.log("Replaced location input with select containing", locations.length, "locations");
                } else {
                    locationInput.placeholder = "Building, area, or specific location";
                }
            } catch (error) {
                console.error("Error in loadDropdownData:", error);
                // Fallback incident types
                incidentTypeSelect.innerHTML = `
                    <option value="">Select event type...</option>
                    <option value="injury">Injury</option>
                    <option value="illness">Illness</option>
                    <option value="near-miss">Near Miss</option>
                    <option value="environmental">Environmental</option>
                    <option value="property-damage">Property Damage</option>
                    <option value="security">Security</option>
                    <option value="other">Other</option>
                `;
                if (locationInput) locationInput.placeholder = "Building, area, or specific location";
            } finally {
                hideLoading();
            }
            console.log("=== loadDropdownData complete ===");
        }

        // Sign-in functionality
        document.getElementById("signinButton").addEventListener("click", async () => {
            const button = document.getElementById("signinButton");
            const originalText = button.textContent;
            button.textContent = "üîÑ Signing in...";
            button.disabled = true;

            try {
                await msalInstance.loginPopup({ scopes: loginScopes });
                showMainForm();
            } catch (error) {
                console.error("Login failed:", error);
                showResult("Login failed: " + error.message, "error");
                button.textContent = originalText;
                button.disabled = false;
            }
        });

        async function showMainForm() {
            console.log("=== showMainForm called ===");
            
            // Debug MSAL account object right after sign-in
            const currentAccount = getCurrentAccount();
            console.log("=== MSAL ACCOUNT DEBUG (after sign-in) ===");
            console.log("Full MSAL account object:", currentAccount);
            
            if (currentAccount) {
                console.log("Account properties:", Object.keys(currentAccount));
                console.log("username:", currentAccount.username);
                console.log("localAccountId:", currentAccount.localAccountId);
                console.log("homeAccountId:", currentAccount.homeAccountId);
                console.log("environment:", currentAccount.environment);
                console.log("tenantId:", currentAccount.tenantId);
                console.log("name:", currentAccount.name);
                console.log("idToken:", currentAccount.idToken);
                console.log("idTokenClaims:", currentAccount.idTokenClaims);
            } else {
                console.log("No current account found!");
            }
            console.log("=== END MSAL ACCOUNT DEBUG ===");
            
            document.getElementById("signinSection").classList.add("hidden");
            document.getElementById("mainForm").classList.remove("hidden");
            await loadDropdownData();
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById("result");
            let icon = '';
            if (type === 'success') icon = '<span class="success-icon"></span>';
            else if (type === 'error') icon = '<span class="error-icon"></span>';
            resultDiv.innerHTML = icon + message;
            resultDiv.className = "result " + type;
        }

        // Build Illness/Injury subform
        function buildIllnessInjurySubform() {
            return `
                <div class="dynamic-fields" id="injuryIllnessSection">
                    <h3>ü©∫ Injury/Illness Details</h3>
                    <div class="form-group">
                        <label for="beforeEvent">What happened just before the event occurred?</label>
                        <textarea id="beforeEvent" placeholder="Describe the context leading up to the event"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="shiftBegin">What time did the work shift begin?</label>
                        <input type="datetime-local" id="shiftBegin">
                    </div>
                    <div class="form-group">
                        <label for="witnesses">Were there any witnesses?</label>
                        <select id="witnesses">
                            <option value="">Select a response...</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="witnessNamesGroup">
                        <label for="witnessNames">List witnesses</label>
                        <input type="text" id="witnessNames" placeholder="Name(s) of witnesses">
                    </div>
                </div>
            `;
        }

        function clearDynamicFields() {
            document.getElementById("dynamicFields").innerHTML = "";
        }

        // Dynamic form fields based on incident type selection
        document.addEventListener("change", function (ev) {
            if (ev.target && ev.target.id === "incidentType") {
                const select = ev.target;
                const val = String(select.value || "").trim();
                const enabled = val !== "";

                setRestEnabled(enabled);
                clearDynamicFields();

                if (!enabled) return;

                const text = (select.options[select.selectedIndex]?.text || "").toLowerCase();
                if (text.includes("illness") || text.includes("injury")) {
                    document.getElementById("dynamicFields").innerHTML = buildIllnessInjurySubform();

                    const witnessesSel = document.getElementById("witnesses");
                    const witnessNamesGroup = document.getElementById("witnessNamesGroup");
                    witnessesSel.addEventListener("change", () => {
                        if (witnessesSel.value === "yes") {
                            witnessNamesGroup.classList.remove("hidden");
                        } else {
                            witnessNamesGroup.classList.add("hidden");
                            const wn = document.getElementById("witnessNames");
                            if (wn) wn.value = "";
                        }
                    });
                }
            }
        });

        // Form submission
        document.getElementById("incidentForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            const submitButtonText = document.getElementById("submitButtonText");
            const originalText = submitButtonText.textContent;

            submitButton.disabled = true;
            submitButtonText.textContent = "üîÑ Submitting...";
            showResult("Submitting incident report...", "loading");

            try {
                const incidentType = document.getElementById("incidentType").value;
                const incidentTypeText = (document.getElementById("incidentType").options[document.getElementById("incidentType").selectedIndex]?.text || "");
                const incidentTypeLower = incidentTypeText.toLowerCase();

                // Parse location data using data attributes (more reliable than JSON)
                const locationEl = document.getElementById("location");
                let locationData = {};
                
                if (locationEl && locationEl.value) {
                    if (locationEl.tagName === 'SELECT' && locationEl.selectedIndex > 0) {
                        const selectedOption = locationEl.options[locationEl.selectedIndex];
                        locationData = {
                            code: selectedOption.value,
                            description: selectedOption.getAttribute('data-description') || '',
                            details: selectedOption.getAttribute('data-details') || ''
                        };
                        console.log("Location data from attributes:", locationData);
                    } else {
                        // Fallback for text input
                        locationData = { 
                            code: locationEl.value, 
                            description: "", 
                            details: "" 
                        };
                    }
                } else {
                    locationData = { code: "", description: "", details: "" };
                }

                const formData = {
                    incidentTypeId: incidentType,
                    incidentTypeName: incidentTypeText,
                    title: (document.getElementById("description").value || "").substring(0, 100) || "Incident Report",
                    occurredAt: new Date(document.getElementById("occurredAt").value).toISOString(),
                    location: locationData.code || "", // Main location code for backward compatibility
                    locationCode: locationData.code || "",
                    locationDescription: locationData.description || "",
                    locationDetails: locationData.details || "",
                    description: document.getElementById("description").value,
                    reportedByEmail: getCurrentAccount()?.username || "",
                    workOrder: document.getElementById("workOrder").value,
                    workOrderBoolean: document.getElementById("workOrder").value === "Yes" ? true : 
                                    document.getElementById("workOrder").value === "No" ? false : null,
                    customFields: { injury: false, illness: false, rootCause: "" }
                };

                // Illness/Injury subform handling
                if (incidentTypeLower.includes("injury") || incidentTypeLower.includes("illness")) {
                    const beforeEvent = document.getElementById("beforeEvent")?.value || "";
                    const shiftBegin = document.getElementById("shiftBegin")?.value || "";
                
                    // CHANGED: keep raw select value for text, but also derive a boolean for payload
                    const witnessesRaw = document.getElementById("witnesses")?.value || "";
                    const witnessesBool = witnessesRaw === "yes" ? true : (witnessesRaw === "no" ? false : null);
                
                    const witnessNames = document.getElementById("witnesses")?.value === "yes"
                        ? (document.getElementById("witnessNames")?.value || "")
                        : "";
                
                    formData.customFields.injury = incidentTypeLower.includes("injury");
                    formData.customFields.illness = incidentTypeLower.includes("illness");
                    formData.customFields.beforeEvent = beforeEvent;
                    formData.customFields.shiftBegin = shiftBegin ? new Date(shiftBegin).toISOString() : "";
                
                    // CHANGED: send boolean/null in the payload instead of "yes"/"no"
                    formData.customFields.witnesses = witnessesBool;
                
                    formData.customFields.witnessNames = witnessNames;
                
                    const label = formData.customFields.injury ? "Injury" : "Illness";
                    formData.customFields.rootCause =
                        `${label}: Before event - ${beforeEvent || "N/A"}, ` +
                        `Shift began: ${shiftBegin || "N/A"}, ` +
                        // keep using the raw value for human-readable text
                        `Witnesses: ${witnessesRaw || "N/A"}${witnessesRaw === "yes" && witnessNames ? " (" + witnessNames + ")" : ""}`;
                } else {
                    formData.customFields.rootCause = document.getElementById("description").value || "No specific root cause identified";
                }


                console.log("Submitting form data:", JSON.stringify(formData, null, 2));

                const response = await fetch(`${apiBaseUrl}/submit`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    showResult("Incident report submitted successfully! Reference ID: " + (result.incidentId || "Generated"), "success");
                    document.getElementById("incidentForm").reset();
                    clearDynamicFields();
                    enableOnlyIncidentType();
                } else {
                    const errorText = await response.text();
                    console.error("Full error response:", errorText);
                    showResult("Submission failed: " + response.status + " - " + errorText, "error");
                }

            } catch (error) {
                console.error("Error submitting form:", error);
                showResult("Error submitting form: " + error.message, "error");
            } finally {
                submitButton.disabled = false;
                submitButtonText.textContent = originalText;
            }
        });

        // Check if user is already signed in
        window.addEventListener("load", async () => {
            const account = getCurrentAccount();
            if (account) { await showMainForm(); }
        });
    </script>
</body>
</html>
